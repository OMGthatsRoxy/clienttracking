# 课程排程页面刷新修复

## 问题描述
当切换页面时，课程排程页面的课程卡片显示不完整，需要每次进入时手动刷新才能正常显示。

## 解决方案

### 1. 页面可见性检测
添加了 `usePageVisibilityRefresh` 自定义Hook，监听页面可见性变化：
- 当页面从隐藏变为可见时自动刷新数据
- 当页面获得焦点时自动刷新数据
- 延迟100ms执行刷新，确保DOM状态稳定

### 2. 数据刷新机制
在 `useScheduleData` Hook中添加了刷新机制：
- 添加 `refreshKey` 状态来触发数据重新获取
- 提供 `refreshData` 函数供外部调用
- 所有数据获取的useEffect都依赖 `refreshKey`

### 3. 组件挂载初始化
添加了组件挂载时的初始化刷新：
- 延迟300ms执行，确保DOM完全渲染
- 重新计算网格尺寸和屏幕检测
- 只在组件挂载时执行一次

### 4. 手动刷新按钮
在页面标题区域添加了刷新按钮：
- 显示刷新图标和文字（移动端只显示图标）
- 点击时手动触发数据刷新和布局重新计算
- 提供用户主动刷新的选项

### 5. 课程卡片优化
优化了 `ScheduleItem` 组件的显示：
- 添加 `zIndex: 5` 确保卡片正确显示
- 设置 `minWidth` 防止卡片过小
- 添加 `maxWidth: '100%'` 防止文本溢出

### 6. 统计信息增强
在标题卡片中添加了更多统计信息：
- 显示当前视图的课程数量
- 帮助用户了解数据加载状态

## 技术实现

### 自动刷新触发条件
1. 页面从隐藏变为可见 (`visibilitychange` 事件)
2. 页面获得焦点 (`focus` 事件)
3. 组件挂载完成
4. 用户手动点击刷新按钮

### 刷新流程
1. 触发 `refreshData()` 函数
2. 更新 `refreshKey` 状态
3. 重新获取所有数据（客户、配套、课程记录、日程表）
4. 延迟重新计算网格尺寸
5. 重新检测屏幕大小和移动端状态

### 错误处理
- 添加了数据获取的错误处理
- 控制台输出调试信息
- 确保刷新失败时不影响页面正常显示

## 使用说明

### 自动刷新
- 当您从其他页面切换回课程排程页面时，系统会自动刷新数据
- 当您切换浏览器标签页再回来时，系统会自动刷新数据
- 当您最小化浏览器窗口再恢复时，系统会自动刷新数据

### 手动刷新
- 点击页面右上角的"🔄 刷新"按钮
- 移动端只显示刷新图标，点击即可刷新

### 验证修复效果
1. 进入课程排程页面
2. 切换到其他页面（如客户管理）
3. 再切换回课程排程页面
4. 观察课程卡片是否正常显示
5. 检查控制台是否有"页面变为可见，刷新数据..."的日志

## 注意事项

1. 刷新会有短暂延迟，这是为了确保DOM状态稳定
2. 频繁切换页面可能会触发多次刷新，这是正常行为
3. 如果仍有显示问题，可以手动点击刷新按钮
4. 刷新过程中会显示加载状态，请耐心等待

## 文件修改

- `src/app/schedule/page.tsx` - 主要修复文件
- `src/components/ScheduleItem.tsx` - 课程卡片组件优化
- `SCHEDULE_REFRESH_FIX.md` - 本文档

## 测试建议

1. 在不同设备上测试（桌面端、移动端）
2. 测试不同的视图模式（日视图、3日视图、周视图、月视图）
3. 测试页面切换的各种场景
4. 验证课程卡片的拖拽功能是否正常
5. 检查数据同步是否正常 