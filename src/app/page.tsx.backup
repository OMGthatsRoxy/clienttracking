"use client";

import LoginForm from "@/features/auth/LoginForm";
import RegisterForm from "@/features/auth/RegisterForm";
import LogoutButton from "@/features/auth/LogoutButton";
import { useAuth } from "@/features/auth/AuthProvider";
import { useLanguage } from "@/features/language/LanguageProvider";
import { useState, useEffect } from "react";
import { doc, getDoc } from "firebase/firestore";
import { db } from "@/lib/firebase";
import type { Coach } from "@/types/coach";
import Link from "next/link";
import StatsCard from "@/components/StatsCard";
import CareerStatsCard from "@/components/CareerStatsCard";

export default function Home() {
  const { user } = useAuth();
  const { t } = useLanguage();
  const [coach, setCoach] = useState<Coach | null>(null);
  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    const fetchCoachInfo = async () => {
      if (!user) return;
      
      try {
        const coachDoc = await getDoc(doc(db, "coaches", user.uid));
        if (coachDoc.exists()) {
          const coachData = { id: coachDoc.id, ...coachDoc.data() } as Coach;
          setCoach(coachData);
        }
      } catch (error) {
        console.error("获取教练信息失败:", error);
      }
    };

    // 检测是否为移动设备
    const checkMobile = () => {
      const userAgent = navigator.userAgent.toLowerCase();
      const isMobileDevice = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
      setIsMobile(isMobileDevice);
    };

    fetchCoachInfo();
    checkMobile();
    window.addEventListener('resize', checkMobile);

    return () => {
      window.removeEventListener('resize', checkMobile);
    };
  }, [user]);

  return (
    <>
      <main className="page-content" style={{
        height: "100vh", // 固定高度为视口高度
        display: "flex",
        flexDirection: "column",
        background: "#18181b",
        padding: isMobile ? "4px" : "8px", // 移动端减少内边距
        position: "relative",
        overflowY: "auto", // 仅在内容超出时显示垂直滚动
        overflowX: "hidden" // 隐藏水平滚动
      }}>
        
        {/* 设置按钮 - 左上角 */}
        {user && (
          <div style={{
            position: "absolute",
            top: isMobile ? "4px" : "12px",
            left: isMobile ? "4px" : "12px",
            zIndex: 100
          }}>
            <Link href="/settings" style={{ textDecoration: "none" }}>
              <button style={{
                background: "rgba(35, 35, 42, 0.9)",
                border: "1px solid #333",
                borderRadius: "8px",
                padding: isMobile ? "10px" : "8px",
                cursor: "pointer",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                width: isMobile ? "44px" : "40px",
                height: isMobile ? "44px" : "40px",
                transition: "all 0.2s ease",
                backdropFilter: "blur(10px)"
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.background = "rgba(35, 35, 42, 1)";
                e.currentTarget.style.borderColor = "#60a5fa";
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.background = "rgba(35, 35, 42, 0.9)";
                e.currentTarget.style.borderColor = "#333";
              }}
              >
                <svg width={isMobile ? "22" : "20"} height={isMobile ? "22" : "20"} viewBox="0 0 24 24" fill="none" stroke="#a1a1aa" strokeWidth="2">
                  <circle cx="12" cy="12" r="3"/>
                  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
              </button>
            </Link>
          </div>
        )}

        
        {/* 主要内容区域 */}
        <div className="page-content" style={{
          flex: 1,
          display: "flex",
          flexDirection: "column",
          alignItems: "center",
          justifyContent: "flex-start",
          paddingTop: isMobile ? 15 : 4, // 移动端为设置按钮留出空间
          overflowY: "auto", // 仅在内容超出时显示垂直滚动
          overflowX: "hidden" // 隐藏水平滚动
        }}>
                                {/* 标题卡片 */}
          <div className="form-card" style={{ 
            maxWidth: 800, 
            width: '100%', 
            marginBottom: 8, // 减少底部间距
            textAlign: "center",
            padding: "12px" // 减少卡片内边距
          }}>
            <h1 style={{
              fontSize: "36px",
              fontWeight: 700,
              color: "#fff",
              marginBottom: 6, // 减少底部间距
              textAlign: "center",
              lineHeight: 1.2
            }}>
              <div>{t('titleLine1')}</div>
              <div style={{ fontSize: "0.9em", marginTop: "2px" }}>{t('titleLine2')}</div>
              <div>{t('titleLine3')}</div>
            </h1>
            <p style={{ 
              color: "#a1a1aa",
              fontSize: "clamp(12px, 3vw, 16px)", // 减小移动端字体
              lineHeight: 1.3,
              margin: 0
            }}>
              {t('loginDescription')}
            </p>
          </div>
          
          {user ? (
            <>
              <div className="form-card" style={{ 
                maxWidth: 800, 
                width: '100%', 
                marginBottom: 8, // 减少底部间距
                textAlign: "center", 
                padding: "8px 12px" // 减少内边距
              }}>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 12 }}> {/* 减少间距 */}
                  {coach?.avatar ? (
                    <img
                      src={coach.avatar}
                      alt="教练头像"
                      style={{
                        width: 50, // 减小头像尺寸
                        height: 50,
                        borderRadius: "50%",
                        objectFit: "cover"
                      }}
                    />
                  ) : (
                    <div style={{
                      width: 50, // 减小头像尺寸
                      height: 50,
                      borderRadius: "50%",
                      background: "#60a5fa",
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "center",
                      fontSize: 20, // 减小字体
                      fontWeight: 600,
                      color: "#18181b"
                    }}>
                      {(coach?.displayName || user.email)?.charAt(0).toUpperCase()}
                    </div>
                  )}
                  <div>
                    <p style={{ 
                      fontSize: "36px",
                      fontWeight: 600,
                      margin: 0,
                      color: "#fff"
                    }}>
                      {t('welcome')}，{coach?.displayName || user.email}
                    </p>
                  </div>
                </div>
              </div>
              
              {/* 本月成绩统计卡片 */}
              <StatsCard />
              
              {/* 我的职业生涯统计卡片 - 增加底部间距 */}
              <div style={{ 
                marginBottom: isMobile ? 20 : 8, // 为最后一张卡片增加额外底部间距
                width: '100%' // 确保宽度一致
              }}> 
                <CareerStatsCard />
              </div>
            </>
          ) : (
            <div style={{ display: "flex", gap: 16, flexWrap: "wrap", justifyContent: "center" }}> {/* 减少间距 */}
              <div className="form-card" style={{ padding: "12px" }}> {/* 减少内边距 */}
                <LoginForm />
              </div>
              <div className="form-card" style={{ padding: "12px" }}> {/* 减少内边距 */}
                <RegisterForm />
              </div>
            </div>
          )}
        </div>
      </main>
    </>
  );
}
